<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg xmlns="http://www.w3.org/2000/svg" width="900" height="440" viewBox="0 0 900 440">
  <style>
    .title { font: 20px sans-serif; }
    .label { font: 14px sans-serif; }
    .small { font: 12px sans-serif; }
    .cluster { fill: #EDE9FE; stroke: #4C1D95; stroke-width: 1.4; stroke-dasharray: 6 4; }
    .box { fill: #FFFFFF; stroke: #312E81; stroke-width: 1.2; }
    .arrow { stroke: #111827; stroke-width: 1.4; marker-end: url(#arrowhead); fill: none; }
  </style>
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#111827" />
    </marker>
  </defs>
  <text x="24" y="36" class="title">Security Context</text>

  <rect x="40" y="60" width="230" height="340" class="cluster" rx="14" ry="14" />
  <text x="60" y="92" class="label">Authentication Module</text>

  <rect x="60" y="120" width="190" height="60" class="box" rx="10" ry="10" />
  <text x="90" y="150" class="label">Local Strategy</text>

  <rect x="60" y="200" width="190" height="60" class="box" rx="10" ry="10" />
  <text x="102" y="230" class="label">JWT Strategy</text>

  <rect x="60" y="280" width="190" height="80" class="box" rx="10" ry="10" />
  <text x="100" y="310" class="label">JwtAuthGuard</text>
  <text x="76" y="332" class="small">attaches user + memberships</text>

  <rect x="310" y="60" width="220" height="160" class="cluster" rx="14" ry="14" />
  <text x="330" y="92" class="label">Role Guards</text>

  <rect x="330" y="120" width="180" height="50" class="box" rx="10" ry="10" />
  <text x="352" y="150" class="label">UserRolesGuard</text>

  <rect x="330" y="190" width="180" height="50" class="box" rx="10" ry="10" />
  <text x="336" y="220" class="label">OrganizationRolesGuard</text>

  <rect x="310" y="240" width="220" height="160" class="cluster" rx="14" ry="14" />
  <text x="330" y="272" class="label">Decorators</text>

  <rect x="330" y="300" width="90" height="40" class="box" rx="8" ry="8" />
  <text x="343" y="325" class="small">@Public</text>

  <rect x="430" y="300" width="90" height="40" class="box" rx="8" ry="8" />
  <text x="436" y="320" class="small">@UserRoles</text>

  <rect x="530" y="300" width="110" height="40" class="box" rx="8" ry="8" />
  <text x="538" y="320" class="small">@OrganizationRoles</text>

  <rect x="650" y="300" width="110" height="40" class="box" rx="8" ry="8" />
  <text x="670" y="320" class="small">@CurrentUser</text>

  <rect x="560" y="60" width="160" height="160" class="cluster" rx="14" ry="14" />
  <text x="580" y="92" class="label">Request Context</text>

  <rect x="580" y="120" width="120" height="50" class="box" rx="10" ry="10" />
  <text x="592" y="150" class="label">HTTP Request</text>

  <rect x="580" y="190" width="120" height="50" class="box" rx="10" ry="10" />
  <text x="592" y="220" class="label">Socket Handshake</text>

  <rect x="750" y="60" width="120" height="240" class="cluster" rx="14" ry="14" />
  <text x="770" y="92" class="label">Services</text>

  <rect x="770" y="120" width="80" height="40" class="box" rx="8" ry="8" />
  <text x="785" y="145" class="small">UserService</text>

  <rect x="770" y="170" width="120" height="40" class="box" rx="8" ry="8" />
  <text x="778" y="195" class="small">OrganizationMemberService</text>

  <rect x="770" y="220" width="90" height="40" class="box" rx="8" ry="8" />
  <text x="782" y="245" class="small">RedisService</text>

  <rect x="770" y="270" width="120" height="40" class="box" rx="8" ry="8" />
  <text x="782" y="295" class="small">DispatchGateway</text>

  <line x1="250" y1="310" x2="580" y2="150" class="arrow" />
  <text x="320" y="262" class="small">attach user + memberships</text>

  <line x1="420" y1="145" x2="580" y2="145" class="arrow" />
  <line x1="420" y1="215" x2="580" y2="215" class="arrow" />

  <line x1="580" y1="150" x2="770" y2="145" class="arrow" />
  <line x1="580" y1="215" x2="770" y2="195" class="arrow" />

  <line x1="770" y1="290" x2="620" y2="210" class="arrow" />
  <line x1="770" y1="290" x2="580" y2="215" class="arrow" />

  <line x1="330" y1="320" x2="250" y2="320" class="arrow" />
  <line x1="430" y1="320" x2="420" y2="240" class="arrow" />
  <line x1="540" y1="320" x2="420" y2="240" class="arrow" />
  <line x1="660" y1="320" x2="600" y2="210" class="arrow" />

  <text x="60" y="400" class="small">@Public bypasses JwtAuthGuard. DispatchGateway verifies JWT during websocket handshake and stores socket IDs in Redis.</text>
</svg>
